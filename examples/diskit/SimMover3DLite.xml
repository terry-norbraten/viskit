<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<SimEntity author="rmgoldbe" package="examples.diskit" version="1.0" name="SimMover3DLite" extend="examples.diskit.DISMover3DBase" xsi:noNamespaceSchemaLocation="http://diana.gl.nps.navy.mil/Simkit/simkit.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <Comment>Unencumbered math version</Comment>
    <Parameter name="start" type="mil.navy.nps.math.Vec4f">
        <Comment>would be nice to have a clone method</Comment>
    </Parameter>
    <Parameter name="speedLimit" type="float">
        <Comment/>
    </Parameter>
    <Parameter name="id" type="short[]">
        <Comment/>
    </Parameter>
    <Parameter name="tol" type="float">
        <Comment>floating point roundoff error tolerance</Comment>
    </Parameter>
    <StateVariable type="mil.navy.nps.math.Vec4f" name="startPosition">
        <Comment/>
    </StateVariable>
    <StateVariable type="float" name="maxSpeed">
        <Comment/>
    </StateVariable>
    <StateVariable type="mil.navy.nps.math.Vec4f" name="velocity">
        <Comment/>
    </StateVariable>
    <StateVariable type="boolean" name="isMoving">
        <Comment/>
    </StateVariable>
    <StateVariable type="mil.navy.nps.math.Vec4f" name="destination">
        <Comment/>
    </StateVariable>
    <StateVariable type="float" name="currentSpeed">
        <Comment/>
    </StateVariable>
    <StateVariable type="float" name="duration">
        <Comment/>
    </StateVariable>
    <Event name="Run">
        <Comment>initialize the mover3D</Comment>
        <StateTransition state="startPosition">
            <Operation method="set(start)"/>
        </StateTransition>
        <StateTransition state="maxSpeed">
            <Assignment value="speedLimit"/>
        </StateTransition>
        <StateTransition state="velocity">
            <Assignment value="new mil.navy.nps.math.Vec4f()"/>
        </StateTransition>
        <StateTransition state="isMoving">
            <Assignment value="false"/>
        </StateTransition>
        <Schedule condition="true" priority="0" delay="0.0" event="Init">
            <Comment/>
            <EdgeParameter value="this"/>
        </Schedule>
        <Coordinate x="40" y="82"/>
    </Event>
    <Event name="Init">
        <Comment>send this</Comment>
        <Argument type="examples.diskit.SimMover3DLite" name="me"/>
        <Coordinate x="43" y="282"/>
    </Event>
    <Event name="StartMove">
        <Comment/>
        <StateTransition state="velocity">
            <Operation method="sub(destination,startPosition)"/>
        </StateTransition>
        <StateTransition state="isMoving">
            <Assignment value="velocity.length_sqr() &gt; tol &amp;&amp; velocity.get(3) &gt; tol"/>
        </StateTransition>
        <StateTransition state="currentSpeed">
            <Assignment value="(float) Math.sqrt((double)velocity.length_sqr())/velocity.get(3)"/>
        </StateTransition>
        <StateTransition state="duration">
            <Assignment value="velocity.get(3)"/>
        </StateTransition>
        <Schedule condition="currentSpeed - maxSpeed &gt; tol" priority="0" delay="0.0" event="SpeedLimit">
            <Comment/>
        </Schedule>
        <Schedule condition="isMoving" priority="0" delay="(double)duration" event="ArrivePoint">
            <Comment/>
        </Schedule>
        <Coordinate x="140" y="157"/>
    </Event>
    <Event name="SpeedLimit">
        <Comment/>
        <LocalVariable type="float[]" name="d" value="new float[4]; destination.get(d)">
            <Comment/>
        </LocalVariable>
        <LocalVariable type="float[]" name="s" value="new float[4]; startPosition.get(s)">
            <Comment/>
        </LocalVariable>
        <StateTransition state="destination">
            <Operation method="set(d[0], d[1], d[2], (float)Schedule.getSimTime() + ((currentSpeed/maxSpeed)*(d[3]-s[3])))"/>
        </StateTransition>
        <StateTransition state="currentSpeed">
            <Assignment value="maxSpeed"/>
        </StateTransition>
        <Cancel event="ArrivePoint"/>
        <Schedule event="StartMove"/>
        <Coordinate x="144" y="381"/>
    </Event>
    <Event name="ArrivePoint">
        <Comment/>
        <StateTransition state="startPosition">
            <Operation method="set(destination)"/>
        </StateTransition>
        <StateTransition state="velocity">
            <Operation method="set(0.0f,0.0f,0.0f,0.0f)"/>
        </StateTransition>
        <StateTransition state="isMoving">
            <Assignment value="false"/>
        </StateTransition>
        <Coordinate x="297" y="198"/>
    </Event>
    <Event name="UpdateDestination">
        <Comment/>
        <Argument type="mil.navy.nps.math.Vec4f" name="newDestination"/>
        <StateTransition state="destination">
            <Operation method="set(newDestination)"/>
        </StateTransition>
        <Schedule event="StartMove"/>
        <Cancel event="ArrivePoint"/>
        <Coordinate x="144" y="36"/>
    </Event>
</SimEntity>

