<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<SimEntity author="jmseguin" extend="SimEntityBase" name="MineField" package="seadiver" version="$Id$" xsi:noNamespaceSchemaLocation="http://diana.gl.nps.navy.mil/Simkit/simkit.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <Parameter name="sensorRange" type="double">
        <Comment>Range of mine's sensor.</Comment>
    </Parameter>
    <Parameter name="numberMines" type="int">
        <Comment>Number of mines in the field.</Comment>
    </Parameter>
    <Parameter name="firstMoverID" type="int">
            <Comment>Determines what number to start iterating mover IDs.</Comment>
    </Parameter>
    <Parameter name="mineFieldWidth" type="double">
        <Comment>Width (X) of the field.</Comment>
    </Parameter>
    <Parameter name="mineFieldLength" type="double">
        <Comment>Length (Y) of the field.</Comment>
    </Parameter>    
    <Parameter name="mineFieldDepth" type="double">
        <Comment>Depth (Z) of the field.</Comment>
    </Parameter>
    <Parameter name="mineDistributionWidth" type="diskit.random.RandomVariateInstantiator">
        <Comment>RV that determines the distribution of mines over the width of the field.</Comment>
    </Parameter>
    <Parameter name="mineDistributionLength" type="diskit.random.RandomVariateInstantiator">
        <Comment>RV that determines the distribution of mines over the length of the field.</Comment>
    </Parameter>
    <Parameter name="mineDistributionDepth" type="diskit.random.RandomVariateInstantiator">
            <Comment>RV that determines the distribution of mines over the height of the field.</Comment>
    </Parameter>
    <StateVariable name="numberOfDetectionsByMine" type="int">
        <Comment>Number of unique detections.</Comment>
    </StateVariable>
    <Event name="Run">
        <Comment/>
        <StateTransition state="numberOfDetectionsByMine">
            <Assignment value="0"/>
        </StateTransition>
        <Schedule condition="true" delay="0.0" event="CreateMine" priority="0">
            <Comment/>
            <EdgeParameter value="firstMoverID"/>
        </Schedule>
        <Code>//System.out.println("Run event for Minefield:  ");</Code>
        <Coordinate x="70" y="50"/>
    </Event>
    <Event name="CreateMine">
        <Comment/>
        <Argument name="moverID" type="int"/>
        <LocalVariable name="movID" type="int" value="moverID">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="x" type="double" value="mineDistributionWidth.generate()">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="y" type="double" value="mineDistributionLength.generate()">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="z" type="double" value="mineDistributionDepth.generate()">
            <Comment/>
        </LocalVariable>
        <Schedule condition="moverID &lt; (getFirstMoverID() + getNumberMines() - 1)" delay="0.0" event="CreateMine" priority="0">
            <Comment/>
            <EdgeParameter value="moverID + 1"/>
        </Schedule>
        <Schedule condition="true" delay="0.0" event="RegisterMine" priority="0">
            <Comment/>
            <EdgeParameter value="movID"/>
            <EdgeParameter value="mineLoc"/>
        </Schedule>
        <Code>diskit.Vec3d mineLoc = new diskit.Vec3d(x,y,z);

// System.out.println("MoverID is:" + moverID);</Code>
        <Coordinate x="70" y="140"/>
    </Event>
    <Event name="RegisterMine">
        <Comment/>
        <Argument name="moverIDnumber" type="int"/>
        <Argument name="mineLocation" type="diskit.Vec3d"/>
        <Schedule condition="true" delay="0.0" event="RegisterTarget" priority="0">
            <Comment/>
            <EdgeParameter value="mine"/>
        </Schedule>
        <Schedule condition="true" delay="0.0" event="RegisterSensor" priority="0">
            <Comment/>
            <EdgeParameter value="new diskit.SphereCutterSensor(mine, sensorRange)"/>
        </Schedule>
        <Code>diskit.DISMover3D mine = new diskit.DISMover3D(mineLocation, 0.0, moverIDnumber);

// System.out.println("Mineinfo is:" + mine.toString());

mine.setPersistant(false);</Code>
        <Coordinate x="70" y="260"/>
    </Event>
    <Event name="RegisterTarget">
        <Comment>Registers mine as a target.</Comment>
        <Argument name="mine" type="diskit.Mover3D"/>
        <Code/>
        <Coordinate x="170" y="230"/>
    </Event>
    <Event name="RegisterSensor">
        <Comment>Registers the mine's sensor with mediator.</Comment>
        <Argument name="sensorIn" type="diskit.Sensor">
            <Comment>Sensor of mine</Comment>
        </Argument>
        <LocalVariable name="sensor" type="diskit.Sensor" value="sensorIn">
            <Comment/>
        </LocalVariable>
        <Code>sensor.addSimEventListener(this);

sensor.setPersistant(false);</Code>
        <Coordinate x="170" y="310"/>
    </Event>
    <Event name="Detection">
        <Comment/>
        <Argument name="sensor" type="diskit.Sensor"/>
        <Argument name="contact" type="diskit.Mover3D"/>
        <Schedule event="RegisterDetection"/>
        <Code>//System.out.println(sensor.getName() + " Detected: " + contact.getName());</Code>
        <Coordinate x="70" y="390"/>
    </Event>
    <Event name="RegisterDetection">
        <Comment/>
        <StateTransition state="numberOfDetectionsByMine">
            <Assignment value="numberOfDetectionsByMine + 1"/>
        </StateTransition>
        <Code>//System.out.println("test of test : " + getNumberOfMineDetections());</Code>
        <Coordinate x="160" y="390"/>
    </Event>
</SimEntity>

