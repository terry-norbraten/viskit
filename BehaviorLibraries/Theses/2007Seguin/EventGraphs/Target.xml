<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<SimEntity author="John Seguin" extend="SimEntityBase" name="Target" package="seadiver" version="$Id$" xsi:noNamespaceSchemaLocation="http://diana.gl.nps.navy.mil/Simkit/simkit.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <Comment>This is a surface/submerged contact that traverses an area patrolled by SeaDiver UUVs.  This mover will move from one side to the other of the area based on random waypoints generated in sequential zones.  Targets must start numbering at 400.
No more than 99 targets allowed.</Comment>
    <Parameter name="speed" type="double">
        <Comment>Speed target is moving across area.</Comment>
    </Parameter>
    <Parameter name="numberOfTargets" type="int">
        <Comment>Number of targets crossing area.</Comment>
    </Parameter>
    <Parameter name="numberOfWaypoints" type="int">
        <Comment>Number of points the targets will navigate through crossing the area.  Zero is straight across.</Comment>
    </Parameter>
    <Parameter name="waypointDistribution" type="diskit.random.RandomVariateInstantiator">
        <Comment>Distribution across width of area for each waypoint.</Comment>
    </Parameter>
    <Parameter name="inputFileTemplate" type="String">
        <Comment>File name and path of the template that the output mission files will be based.</Comment>
    </Parameter>
    <Parameter name="outputFileName" type="String">
        <Comment>Name and path where created mission files will be written.</Comment>
    </Parameter>
    <Parameter name="operatingDepth" type="double">
        <Comment>Operating depth of the target.</Comment>
    </Parameter>
    <Parameter name="sensorRange" type="double">
        <Comment>Range of the sensor for the Target.</Comment>
    </Parameter>
    <StateVariable name="zoneList" type="java.util.LinkedList">
        <Comment>List of zones for waypoint creation.  The total area is divided up into a number of equal area zones, one for each waypoint.</Comment>
    </StateVariable>
    <StateVariable name="activeMoverManager" type="seadiver.MoverManager">
        <Comment>Stores the active mover manager.</Comment>
    </StateVariable>
    <StateVariable name="yRandomVariate" type="simkit.random.RandomVariate">
        <Comment>Distribution across the length dimension of area for each waypoint.</Comment>
    </StateVariable>
    <StateVariable name="zRandomVariate" type="simkit.random.RandomVariate">
        <Comment>Distribution across the z(depth) of area for each waypoint.</Comment>
    </StateVariable>
    <StateVariable name="randomVariateArray" type="simkit.random.RandomVariate[3]">
        <Comment>Holds random variates to be passed to TargetWaypointCreator for creation of target path.</Comment>
    </StateVariable>
    <StateVariable name="randomNumberGenerator" type="seadiver.RandomNumberGenerator">
        <Comment>Reference to object that supplies random numbers.</Comment>
    </StateVariable>
    <StateVariable name="targetWaypointCreator" type="seadiver.TargetWaypointCreator">
        <Comment>Instance of TargetWaypointCreator that creates waypoints for target use navigating through the area.</Comment>
    </StateVariable>
    <StateVariable name="numberOfSeadiverDetections" type="int">
        <Comment>Number of Seadiver detections by Target.</Comment>
    </StateVariable>
    <Event name="Run">
        <Comment/>
        <StateTransition state="yRandomVariate">
            <Assignment value="null"/>
        </StateTransition>
        <StateTransition state="zRandomVariate">
            <Assignment value="null"/>
        </StateTransition>
        <StateTransition state="activeMoverManager">
            <Assignment value="null"/>
        </StateTransition>
        <StateTransition state="targetWaypointCreator">
            <Assignment value="null"/>
        </StateTransition>
        <StateTransition state="randomNumberGenerator">
            <Assignment value="null"/>
        </StateTransition>
        <Schedule condition="true" delay="0.0" event="DetermineTargetZones" priority="0">
            <Comment/>
            <EdgeParameter value="getNumberOfWaypoints()"/>
            <EdgeParameter value="getNumberOfTargets()"/>
        </Schedule>
        <Code/>
        <Coordinate x="60" y="80"/>
    </Event>
    <Event name="DetermineTargetZones">
        <Comment>Passes the number of waypoints to ZoneMap for creation of zones.</Comment>
        <Argument name="numWPs" type="int">
            <Comment>Number of waypoints (zones) to be created.</Comment>
        </Argument>
        <Argument name="numTgts" type="int"/>
        <Code/>
        <Coordinate x="150" y="80"/>
    </Event>
    <Event name="RegisterZones">
        <Comment/>
        <Argument name="wpZones" type="java.util.LinkedList">
            <Comment>List of zones to be used to generate the waypoints.</Comment>
        </Argument>
        <StateTransition state="zoneList">
            <Assignment value="wpZones"/>
        </StateTransition>
        <StateTransition state="randomNumberGenerator">
            <Assignment value="new seadiver.RandomNumberGenerator(randomVariateArray)"/>
        </StateTransition>
        <StateTransition state="targetWaypointCreator">
            <Assignment value="new seadiver.TargetWaypointCreator(getZoneList(), getNumberOfTargets(), getRandomNumberGenerator(), getSpeed(), getInputFileTemplate(), getOutputFileName(), getOperatingDepth())"/>
        </StateTransition>
        <Schedule condition="true" delay="0.0" event="CreateTarget" priority="0">
            <Comment/>
            <EdgeParameter value="400"/>
        </Schedule>
        <Code>// System.out.println("wpZones  " + wpZones.toString() );

yRandomVariate = RandomVariateFactory.getInstance("Uniform", new Object[] { new Double(0.0),new Double(1.0) });

zRandomVariate = RandomVariateFactory.getInstance("Uniform", new Object[] { new Double(0.0),new Double(1.0) });

randomVariateArray[0] = waypointDistribution.getRandomVariate();
randomVariateArray[1] = yRandomVariate;
randomVariateArray[2] = zRandomVariate;</Code>
        <Coordinate x="60" y="160"/>
    </Event>
    <Event name="CreateTarget">
        <Comment>Iterates MoverID starting at 400</Comment>
        <Argument name="moverID" type="int"/>
        <Schedule condition="moverID &lt; (399 + getNumberOfTargets())" delay="0.0" event="CreateTarget" priority="0">
            <Comment/>
            <EdgeParameter value="moverID + 1"/>
        </Schedule>
        <Schedule condition="true" delay="0.0" event="RegisterMover" priority="0">
            <Comment/>
            <EdgeParameter value="moverID"/>
            <EdgeParameter value="new diskit.Vec3d(0.0,0.0,0.0)"/>
            <EdgeParameter value="moverID - 400"/>
        </Schedule>
        <Code/>
        <Coordinate x="150" y="160"/>
    </Event>
    <Event name="RegisterMover">
        <Comment/>
        <Argument name="movID" type="int"/>
        <Argument name="sLoc" type="diskit.Vec3d"/>
        <Argument name="iterator" type="int"/>
        <Schedule condition="true" delay="0.0" event="RegisterTarget" priority="0">
            <Comment/>
            <EdgeParameter value="target"/>
        </Schedule>
        <Schedule condition="true" delay="0.0" event="ProcessWaypoints" priority="0">
            <Comment/>
            <EdgeParameter value="target"/>
        </Schedule>
        <Schedule condition="true" delay="0.0" event="RegisterSensor" priority="0.0">
            <Comment/>
            <EdgeParameter value="new diskit.SphereCutterSensor(target, getSensorRange())"/>
        </Schedule>
        <Code>seadiver.DISMover3D target = (seadiver.DISMover3D) new seadiver.DISMover3D(sLoc, getSpeed(), movID);
target.setPersistant(false);

target.setTacticalMode(diskit.TacticalMode.IDLE);</Code>
        <Coordinate x="240" y="160"/>
    </Event>
    <Event name="RegisterTarget">
        <Comment>Required event by superclass</Comment>
        <Argument name="mover" type="diskit.DISMover3D"/>
        <Code/>
        <Coordinate x="210" y="250"/>
    </Event>
    <Event name="ProcessWaypoints">
        <Comment/>
        <Argument name="mover" type="seadiver.DISMover3D"/>
        <Schedule condition="true" delay="0.0" event="StartMoving" priority="0">
            <Comment/>
            <EdgeParameter value="mover"/>
        </Schedule>
        <Code>seadiver.PathMoverManager pathMoverManager = new seadiver.PathMoverManager(mover, targetWaypointCreator.getWaypoints(mover.getMoverID()-400), true, false);

pathMoverManager.setPersistant(false);

activeMoverManager = pathMoverManager;

activeMoverManager.setPersistant(false);</Code>
        <Coordinate x="340" y="160"/>
    </Event>
    <Event name="StartMoving">
        <Comment/>
        <Argument name="tgt" type="seadiver.DISMover3D"/>
        <Code>//System.out.println("\n\n\n\n\n\n" + targetWaypointCreator.printWaypoints(tgt.getMoverID()-400));

tgt.setTacticalMode(diskit.TacticalMode.TRANSITING);
tgt.setMaximumSpeed(getSpeed());
tgt.setCruiseSpeed(getSpeed());
tgt.setStartPosition((diskit.Vec3d) targetWaypointCreator.getStartPosition(tgt.getMoverID()-400));
//System.out.println(" StartPosition is:  "+tgt.getStartPosition() + "\n\n");

tgt.setDestination((diskit.Vec3d) targetWaypointCreator.getFirstWaypoint(tgt.getMoverID()-400));
//System.out.println(" Destination is:  "+tgt.getDestination() +"\n\n");

tgt.start();</Code>
        <Coordinate x="340" y="250"/>
    </Event>
    <Event name="RegisterSensor">
        <Comment/>
        <Argument name="sensorIn" type="diskit.Sensor"/>
        <LocalVariable name="sensor" type="diskit.Sensor" value="sensorIn">
            <Comment/>
        </LocalVariable>
        <Code>sensor.addSimEventListener(this);</Code>
        <Coordinate x="270" y="250"/>
    </Event>
    <Event name="Detection">
        <Comment/>
        <Argument name="sensor" type="diskit.Sensor"/>
        <Argument name="contact" type="diskit.Mover3D"/>
        <Schedule event="RegisterDetection"/>
        <Code/>
        <Coordinate x="60" y="320"/>
    </Event>
    <Event name="RegisterDetection">
        <Comment/>
        <StateTransition state="numberOfSeadiverDetections">
            <Assignment value="numberOfSeadiverDetections + 1"/>
        </StateTransition>
        <Code/>
        <Coordinate x="150" y="320"/>
    </Event>
    <Code/>
</SimEntity>

