<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<SimEntity author="Patrick Sullivan" extend="diskit.NeutralForce" name="NeutralCraft" package="diskit" version="1.0" xsi:noNamespaceSchemaLocation="http://diana.gl.nps.navy.mil/Simkit/simkit.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <Comment>A Neutral Craft which will navigate through it's assigned zones. Most common use for this class is as traffic for a harbor or any other entity type that is neither a defender or an attacker.</Comment>
    <Parameter name="moverID" type="int">
        <Comment>DIS entity ID</Comment>
    </Parameter>
    <Parameter name="startPosition" type="diskit.Vec3d">
        <Comment>Start Position - different than first waypoint</Comment>
    </Parameter>
    <Parameter name="maximumSpeed" type="double">
        <Comment>Speed of this entity</Comment>
    </Parameter>
    <Parameter name="name" type="java.lang.String">
        <Comment>Should match name in Assembly</Comment>
    </Parameter>
    <StateVariable name="tacticalMode" type="diskit.TacticalMode">
        <Comment>Tactical Mode of this entity</Comment>
    </StateVariable>
    <StateVariable name="assetState" type="diskit.AssetState">
        <Comment>Asset State of this entity</Comment>
    </StateVariable>
    <StateVariable name="perception" type="diskit.Sensor">
        <Comment>Perceptual Range of Entity for Detection and Avoidance</Comment>
    </StateVariable>
    <StateVariable name="obstacleQueue" type="diskit.ObstacleQueue">
        <Comment>Collection of obstacles for this entity to negotiate</Comment>
    </StateVariable>
    <StateVariable name="avoidanceRange" type="double">
        <Comment>Contact proximity tolerance for this entity</Comment>
    </StateVariable>
    <StateVariable name="activeMoverManager" type="diskit.MoverManager">
        <Comment>Used as a placeholder for managing various mover managers</Comment>
    </StateVariable>
    <StateVariable name="patrolManager" type="diskit.ZoneMoverManager">
        <Comment>Primary mover manager, used for moving entities from waypoint to waypoint</Comment>
    </StateVariable>
    <StateVariable name="waypointCreator" type="diskit.WaypointCreator">
        <Comment>generates waypoints within geometry bounds based on probabilities</Comment>
    </StateVariable>
    <StateVariable name="interceptMoverManager" type="diskit.InterceptMoverManager">
        <Comment>Mover Manager that executes an intercept</Comment>
    </StateVariable>
    <StateVariable name="targetQueue" type="java.util.LinkedList">
        <Comment>Collection of potential targets (NOTE: may not be necessary for a neutral, but left in the graph in case a modified neutral -&gt; hostile agent is desired)</Comment>
    </StateVariable>
    <StateVariable name="canIntercept" type="boolean">
        <Comment>True/false return from intercept mover manager, returns false when an intercept is impossible based of the speed and range of this entity and the target</Comment>
    </StateVariable>
    <StateVariable name="reach" type="diskit.Sensor">
        <Comment>reach is the range of the sensor that is used to determine whether there is going to be an intercept or not.</Comment>
    </StateVariable>
    <StateVariable name="geomIndex" type="int">
        <Comment>index variable used to count number of zones that are pertainent to this entity</Comment>
    </StateVariable>
    <Event name="Run">
        <Comment/>
        <StateTransition state="tacticalMode">
            <Assignment value="diskit.TacticalMode.TRANSITING"/>
        </StateTransition>
        <StateTransition state="avoidanceRange">
            <Assignment value="30"/>
        </StateTransition>
        <StateTransition state="patrolManager">
            <Assignment value="null"/>
        </StateTransition>
        <StateTransition state="interceptMoverManager">
            <Assignment value="null"/>
        </StateTransition>
        <StateTransition state="targetQueue">
            <Operation method="clear()"/>
        </StateTransition>
        <StateTransition state="obstacleQueue">
            <Assignment value="new diskit.ObstacleQueue(getLocation())"/>
        </StateTransition>
        <Code/>
        <Coordinate x="20" y="30"/>
    </Event>
    <Event name="StartMove">
        <Comment/>
        <LocalVariable name="movement" type="boolean" value="true; setCruiseSpeed(maximumSpeed); start()">
            <Comment/>
        </LocalVariable>
        <StateTransition state="tacticalMode">
            <Assignment value="diskit.TacticalMode.TRANSITING"/>
        </StateTransition>
        <Code/>
        <Coordinate x="20" y="330"/>
    </Event>
    <Event name="EndMove">
        <Comment/>
        <Argument name="mover" type="diskit.Mover3D"/>
        <LocalVariable name="m" type="boolean" value="true; setStartPosition(getLocation())">
            <Comment/>
        </LocalVariable>
        <Schedule condition="tacticalMode == diskit.TacticalMode.ESCORTED" delay="0.0" event="StartMove" priority="0">
            <Comment/>
        </Schedule>
        <Code/>
        <Coordinate x="440" y="330"/>
    </Event>
    <Event name="Init">
        <Comment/>
        <Argument name="entity" type="diskit.Mover3D"/>
        <StateTransition state="reach">
            <Assignment value="new diskit.SphereCutterSensor(this,avoidanceRange)"/>
        </StateTransition>
        <Schedule condition="entity == this" delay="0.0" event="RegisterTarget" priority="0">
            <Comment/>
            <EdgeParameter value="this"/>
        </Schedule>
        <Schedule condition="true" delay="0.0" event="RegisterSensor" priority="0">
            <Comment/>
            <EdgeParameter value="reach"/>
        </Schedule>
        <Code/>
        <Coordinate x="90" y="30"/>
    </Event>
    <Event name="RegisterTarget">
        <Comment/>
        <Argument name="target" type="diskit.Mover3D"/>
        <Coordinate x="200" y="30"/>
    </Event>
    <Event name="RegisterSensor">
        <Comment>Registering of Sensor with the Scenario Manager</Comment>
        <Argument name="newPercept" type="diskit.Sensor"/>
        <LocalVariable name="sensor" type="diskit.Sensor" value="newPercept">
            <Comment/>
        </LocalVariable>
        <Code>sensor.addSimEventListener(this);</Code>
        <Coordinate x="200" y="110"/>
    </Event>
    <Event name="Detection">
        <Comment/>
        <Argument name="sensor" type="diskit.Sensor"/>
        <Argument name="newTarget" type="diskit.Mover3D"/>
        <StateTransition state="obstacleQueue">
            <Operation method="add(newTarget)"/>
        </StateTransition>
        <Cancel event="EndMove"/>
        <Schedule condition="!obstacleQueue.contains(newTarget)" delay="0.0" event="AssessObstacle" priority="0">
            <Comment/>
            <EdgeParameter value="newTarget"/>
        </Schedule>
        <Code>/*System.out.println("***Simulation Time ***");
System.out.println(Schedule.getSimTime());
System.out.println("----------EVENT------------");
System.out.println(getMoverID() + " Detected entity# " + newTarget.getMoverID());
System.out.println("\n");
*/
//System.out.println("Entity Speed: " + newTarget.getCruiseSpeed());
//System.out.println("Entity Dest:    " + newTarget.getDestination());</Code>
        <Coordinate x="440" y="440"/>
    </Event>
    <Event name="AssessObstacle">
        <Comment/>
        <Argument name="newTarget" type="diskit.Mover3D"/>
        <LocalVariable name="closest" type="diskit.Mover3D" value="obstacleQueue.closest()">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="tgetVel" type="diskit.Vec3d" value="new diskit.Vec3d(newTarget.getVelocity())">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="times" type="double[]" value="diskit.Intersector3D.solve(perception.getLocation(),perception.getVelocity(), avoidanceRange, newTarget.getLocation(), newTarget.getVelocity());">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="collidePoint" type="diskit.Vec3d" value="diskit.util.Math3D.findInterceptPoint(newTarget,(diskit.Mover3D)this,getCruiseSpeed())">
            <Comment/>
        </LocalVariable>
        <StateTransition state="obstacleQueue">
            <Operation method="add(newTarget)"/>
        </StateTransition>
        <Schedule condition="( times[0] &gt; 0.0 ) &amp;&amp; (  times[0] &lt; Double.POSITIVE_INFINITY )" delay="0.0" event="AvoidObstacle" priority="0">
            <Comment/>
            <EdgeParameter value="newTarget"/>
        </Schedule>
        <Code>if (tgetVel.length() &lt; .1) {  tgetVel.set(getVelocity());  tgetVel.negate();tgetVel.scale(.1);  }</Code>
        <Coordinate x="280" y="440"/>
    </Event>
    <Event name="AvoidObstacle">
        <Comment/>
        <Argument name="obstacle" type="diskit.Mover3D"/>
        <LocalVariable name="loc" type="diskit.Vec3d" value="new diskit.Vec3d(getLocation())">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="up" type="diskit.Vec3d" value="new diskit.Vec3d(0.0,0.0,-1.0)">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="steer" type="diskit.Vec3d" value="new diskit.Vec3d()">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="veer" type="diskit.Vec3d" value="new diskit.Vec3d()">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="amm" type="diskit.AvoidanceMoverManager" value="new diskit.AvoidanceMoverManager(this)">
            <Comment/>
        </LocalVariable>
        <Schedule event="StartMove"/>
        <Code>steer.cross(getVelocity(),obstacle.getVelocity()); /**      * Should be moved to Avoidance Mover Manager at some point     */  if ( steer.length() &lt; getCruiseSpeed() ) {          steer.cross(velocity,up);          veer.set(getLocation());   } else {       steer.cross(up);      veer.set(obstacle.getLocation());  veer.set(0,(veer.get(0)/2.0) + (loc.get(0)/2.0));  veer.set(1, (veer.get(1)/2.0)+(loc.get(1)/2.0));      veer.set( 2, (veer.get(2)/2.0)+(loc.get(2)/2.0) );   }      veer.add(steer); amm.avoidToOffset(veer, getActiveMoverManager());System.out.println(getMoverID() + " Avoiding entity# " + obstacle.getMoverID());</Code>
        <Coordinate x="100" y="440"/>
    </Event>
    <Event name="CreateZones">
        <Comment>Listens to the Harbor Creator to get Zone Assignment geometry</Comment>
        <Argument name="patrolAssignment" type="ZoneGeometry[]">
            <Comment>Passed by the Harbor Creator - states patrol responsibilities and contains entity ID for assignment</Comment>
        </Argument>
        <LocalVariable name="count" type="int" value="0">
            <Comment>tracks number of patrol zone assignments</Comment>
        </LocalVariable>
        <LocalVariable name="idx" type="int" value="0">
            <Comment>Used for patrol zone array construction</Comment>
        </LocalVariable>
        <LocalVariable name="duties" type="ZoneGeometry[]" value="null">
            <Comment/>
        </LocalVariable>
        <StateTransition state="waypointCreator">
            <Assignment value="new WaypointCreator(duties)"/>
        </StateTransition>
        <StateTransition state="patrolManager">
            <Assignment value="new diskit.ZoneMoverManager(this, waypointCreator,avoidanceRange)"/>
        </StateTransition>
        <StateTransition state="activeMoverManager">
            <Assignment value="patrolManager"/>
        </StateTransition>
        <Schedule event="StartMove"/>
        <Code>for(int i = 0; i&lt;patrolAssignment.length; i++){     if(patrolAssignment[i].getID() == moverID){                       count++;        }  }  duties = new ZoneGeometry[count];  for(int i = 0; i &lt; patrolAssignment.length; i++){   if(patrolAssignment[i].getID() == moverID){      duties[idx] = patrolAssignment[i];      idx++;      }  } setStartPosition(duties[0].getCenter3D());</Code>
        <Coordinate x="20" y="190"/>
    </Event>
    <Event name="ClearExclusionZone">
        <Comment/>
        <Argument name="target" type="diskit.Mover3D"/>
        <StateTransition state="interceptMoverManager">
            <Operation method="setMover(null)"/>
        </StateTransition>
        <StateTransition state="activeMoverManager">
            <Assignment value="patrolManager"/>
        </StateTransition>
        <StateTransition state="activeMoverManager">
            <Operation method="setMover(this)"/>
        </StateTransition>
        <Schedule event="StartMove"/>
        <Code>setStartPosition(getLocation());System.out.println("Oh, sorry, changing course");</Code>
        <Coordinate x="290" y="220"/>
    </Event>
    <Code/>
</SimEntity>

