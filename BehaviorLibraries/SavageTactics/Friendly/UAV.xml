<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<SimEntity author="pjsulliv" extend="diskit.FriendlyForce" name="UAV" package="Friendly" version="1.0" xsi:noNamespaceSchemaLocation="http://diana.gl.nps.navy.mil/Simkit/simkit.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <Comment>An unmanned arial vehicle. Current implementation has one sensor, air detection which can also detect contacts on the surface within it's sensor range</Comment>
    <Parameter name="moverID" type="int">
        <Comment>DIS entity ID</Comment>
    </Parameter>
    <Parameter name="entityDefinition" type="diskit.SMAL.EntityDefinition">
        <Comment>The Savage Modeling Analysis Language(SMAL) object that contains all specific information about the model being used</Comment>
    </Parameter>
    <Parameter name="zones" type="diskit.ProbabilityZoneGeometry[]">
        <Comment>General areas from which waypoints should be generated for this entity.</Comment>
    </Parameter>
    <Parameter name="communicationDelay" type="diskit.random.RandomVariateInstantiator">
        <Comment>The distribution of the delay for a signal to be transmitted from this platform</Comment>
    </Parameter>
    <Parameter name="commsChannel" type="int">
        <Comment>The channel that this entity is communicating on</Comment>
    </Parameter>
    <Parameter name="digitalCameraSensor" type="diskit.Sensor">
        <Comment/>
    </Parameter>
    <Parameter name="airSearchRadarSensor" type="diskit.Sensor">
        <Comment/>
    </Parameter>
    <Parameter name="collisionSensor" type="diskit.Sensor">
        <Comment/>
    </Parameter>
    <StateVariable name="visualRange" type="double">
        <Comment>The range of the camera sensor on this platform</Comment>
    </StateVariable>
    <StateVariable name="airSearchRadarRange" type="double">
        <Comment>The maximum range of the air search radar on this platform</Comment>
    </StateVariable>
    <StateVariable name="avoidanceRange" type="double">
        <Comment>Contact proximity tolerance for this entity, used for collision avoidance</Comment>
    </StateVariable>
    <StateVariable name="digitalCamera" type="diskit.Sensor">
        <Comment>The digital camera on this platform</Comment>
    </StateVariable>
    <StateVariable name="airSearchRadar" type="diskit.Sensor">
        <Comment>The air search radar on this platform</Comment>
    </StateVariable>
    <StateVariable name="collisionDetection" type="diskit.Sensor">
        <Comment>A collision avoidance sensor for this platform</Comment>
    </StateVariable>
    <StateVariable name="activeMoverManager" type="diskit.MoverManager">
        <Comment>The mover manager that is currently being used. Primarily used for swapping between mover manager types</Comment>
    </StateVariable>
    <StateVariable name="zoneMoverManager" type="diskit.ZoneMoverManager">
        <Comment>[Primary] mover manager used to transit in designated areas defined by the 'zones' parameter</Comment>
    </StateVariable>
    <StateVariable name="avoidanceMoverManager" type="diskit.AvoidanceMoverManager">
        <Comment>[Secondary] Mover Manager used for avoidance movement</Comment>
    </StateVariable>
    <StateVariable name="interceptMoverManager" type="diskit.InterceptMoverManager">
        <Comment>[Not used] Mover Manager that executes an interception</Comment>
    </StateVariable>
    <StateVariable name="pathMoverManager" type="diskit.PathMoverManager">
        <Comment>[Not used] Mover Manager that moves in a predetermined path</Comment>
    </StateVariable>
    <StateVariable name="waypointCreator" type="diskit.WaypointCreator">
        <Comment>[Mode - Probability] generates waypoints based on 'zones' parameter</Comment>
    </StateVariable>
    <StateVariable name="tacticalMode" type="diskit.TacticalMode">
        <Comment>Tactical Mode of this entity</Comment>
    </StateVariable>
    <StateVariable name="obstacleQueue" type="diskit.ObstacleQueue">
        <Comment>Collection of obstacles for this entity to negotiate</Comment>
    </StateVariable>
    <StateVariable name="speedScale" type="double">
        <Comment>A scalar variable which is applied to the speed of this entity. Variation in the speed scale is set for all entities by the diskit.ScenarioManager. This allows for simulation wide speed up /slow down functionality</Comment>
    </StateVariable>
    <StateVariable name="altitudeFloor" type="double">
        <Comment>The lowest altitude that this platform should be at during normal operation (e.g. not landing)</Comment>
    </StateVariable>
    <StateVariable name="radioCommunication" type="diskit.RadioCommunication">
        <Comment>An object used to transmit radio Communications</Comment>
    </StateVariable>
    <StateVariable name="contactPicture" type="diskit.ContactPicture">
        <Comment>A local list of contacts that have been reported</Comment>
    </StateVariable>
    <StateVariable name="transmitDelay" type="double">
        <Comment>The delay for sending communciation signals</Comment>
    </StateVariable>
    <StateVariable name="harborChart" type="diskit.AStarZoneMap">
        <Comment>A local copy of an AStarZoneMap object,recevied from the ScenarioManager</Comment>
    </StateVariable>
    <StateVariable name="reportedContacts" type="int">
        <Comment>Tally of contacts reported by this entity</Comment>
    </StateVariable>
    <Event name="Run">
        <Comment>The run event sets the parameter values for each simulation run</Comment>
        <StateTransition state="tacticalMode">
            <Assignment value="diskit.TacticalMode.TRANSITING"/>
        </StateTransition>
        <StateTransition state="zoneMoverManager">
            <Assignment value="null"/>
        </StateTransition>
        <StateTransition state="avoidanceMoverManager">
            <Assignment value="null"/>
        </StateTransition>
        <StateTransition state="obstacleQueue">
            <Assignment value="new diskit.ObstacleQueue(getLocation())"/>
        </StateTransition>
        <StateTransition state="speedScale">
            <Assignment value="1.0"/>
        </StateTransition>
        <StateTransition state="visualRange">
            <Assignment value="getDigitalCameraSensor().getMaxRange()"/>
        </StateTransition>
        <StateTransition state="airSearchRadarRange">
            <Assignment value="getAirSearchRadarSensor().getMaxRange()"/>
        </StateTransition>
        <StateTransition state="avoidanceRange">
            <Assignment value="getCollisionSensor().getMaxRange()"/>
        </StateTransition>
        <StateTransition state="digitalCamera">
            <Assignment value="getDigitalCameraSensor()"/>
        </StateTransition>
        <StateTransition state="airSearchRadar">
            <Assignment value="getAirSearchRadarSensor()"/>
        </StateTransition>
        <StateTransition state="collisionDetection">
            <Assignment value="getCollisionSensor()"/>
        </StateTransition>
        <Schedule condition="true" delay="0.0" event="Init" priority="0.0">
            <Comment/>
            <EdgeParameter value="this"/>
        </Schedule>
        <Code/>
        <Coordinate x="10" y="10"/>
    </Event>
    <Event name="Init">
        <Comment>An initialization event that is scheduled by diskit.SMALMover3D to initialize it's subclasses. The event creates sensor objects and registers this mover and it's sensors with the diskit.ScenarioManager.</Comment>
        <Argument name="init" type="diskit.Mover3D"/>
        <StateTransition state="digitalCamera">
            <Operation method="setMover(this)"/>
        </StateTransition>
        <StateTransition state="airSearchRadar">
            <Operation method="setMover(this)"/>
        </StateTransition>
        <StateTransition state="collisionDetection">
            <Operation method="setMover(this)"/>
        </StateTransition>
        <StateTransition state="contactPicture">
            <Operation method="clear()"/>
        </StateTransition>
        <StateTransition state="radioCommunication">
            <Assignment value="new diskit.RadioCommunication()"/>
        </StateTransition>
        <StateTransition state="radioCommunication">
            <Operation method="setSender(this)"/>
        </StateTransition>
        <StateTransition state="radioCommunication">
            <Operation method="setChannel(commsChannel)"/>
        </StateTransition>
        <StateTransition state="radioCommunication">
            <Operation method="setRecipients(friendlyForceList)"/>
        </StateTransition>
        <StateTransition state="radioCommunication">
            <Operation method="setType(&quot;UAV Contact Report&quot;)"/>
        </StateTransition>
        <Schedule condition="init == this" delay="0.0" event="RegisterTarget" priority="0.0">
            <Comment/>
            <EdgeParameter value="this"/>
        </Schedule>
        <Schedule condition="zones.length &gt; 0 &amp;&amp; init == this" delay="0.0" event="BuildSensorArray" priority="0.0">
            <Comment>If this zone is moving register all sensors</Comment>
        </Schedule>
        <Code>/* either do this here, make these parameters, or push down to base classes */
if (avoidanceMoverManager == null) {
    avoidanceMoverManager = new diskit.AvoidanceMoverManager(null);
}

if (zoneMoverManager == null) {
    zoneMoverManager = new diskit.ZoneMoverManager(this);
}</Code>
        <Coordinate x="100" y="10"/>
    </Event>
    <Event name="ApplySpeedScale">
        <Comment>This event is scheduled by the diskit.ScenarioManager. All entities that have this event in their graph will adjust their speed values by the speed scale which will be applied throughout the entire simulation. Scheduling of this event occurs as part of the 'doRegisterTarget' process in diskit.ScenarioManager.</Comment>
        <Argument name="speedScaleChange" type="double">
            <Comment>The uniform speed scale change for this simulation</Comment>
        </Argument>
        <StateTransition state="speedScale">
            <Assignment value="speedScaleChange"/>
        </StateTransition>
        <Code/>
        <Coordinate x="100" y="240"/>
    </Event>
    <Event name="RegisterTarget">
        <Comment>Registers this mover with the diskit.ScenarioManager</Comment>
        <Argument name="mover" type="diskit.Mover3D">
            <Comment>This object should pass itself as an argument to this event as part of the registration process</Comment>
        </Argument>
        <Code/>
        <Coordinate x="180" y="10"/>
    </Event>
    <Event name="RegisterSensors">
        <Comment>Registers the complete sensor array if and only if this entity has at least one probability zone</Comment>
        <Argument name="sensors" type="diskit.Sensor[]">
            <Comment>The complete collection of sensors for this entity</Comment>
        </Argument>
        <Code/>
        <Coordinate x="180" y="150"/>
    </Event>
    <Event name="ProcessZones">
        <Comment>This event creates waypoint creator and mover manager objects with the zones that were included as a parameter to this graph. If no zones are specificed the movement process will not be scheduled.</Comment>
        <StateTransition state="waypointCreator">
            <Assignment value="new diskit.WaypointCreator(zones)"/>
        </StateTransition>
        <StateTransition state="zoneMoverManager">
            <Operation method="setWaypointCreator(waypointCreator)"/>
        </StateTransition>
        <Schedule condition="true" delay="0.1" event="StartMoving" priority="0.0">
            <Comment/>
        </Schedule>
        <Code/>
        <Coordinate x="100" y="360"/>
    </Event>
    <Event name="StartMoving">
        <Comment>Begins the movement of this entity. Continuous movement based on waypoints from the provided zones will continue until the mover manager is changed</Comment>
        <LocalVariable name="initialStartPosition" type="diskit.Vec3d" value="waypointCreator.createWaypoint()">
            <Comment>An initial waypoint in one of the provided zones</Comment>
        </LocalVariable>
        <LocalVariable name="initialDestination" type="diskit.Vec3d" value="waypointCreator.createWaypoint()">
            <Comment>An initial destination selected from one of the zones</Comment>
        </LocalVariable>
        <StateTransition state="activeMoverManager">
            <Assignment value="zoneMoverManager"/>
        </StateTransition>
        <Code>setMaximumSpeed(getEntityDefinition().getMaximumSpeed() * speedScale);
setStartPosition(initialStartPosition);
setCruiseSpeed(getEntityDefinition().getCruiseSpeed() * speedScale);
setDestination(initialDestination);
start();</Code>
        <Coordinate x="300" y="360"/>
    </Event>
    <Event name="Detection">
        <Comment>A detection event from any sensor that this entity is listening to (e.g. registered with the simulation)</Comment>
        <Argument name="sensor" type="diskit.Sensor">
            <Comment>The sensor that detected another simEntity</Comment>
        </Argument>
        <Argument name="contact" type="diskit.Mover3D">
            <Comment>The mover that was detected</Comment>
        </Argument>
        <LocalVariable name="isFriendlyForce" type="boolean" value="friendlyForces.contains(contact.getMoverID())">
            <Comment>Whether or not this contact is a friendly force</Comment>
        </LocalVariable>
        <LocalVariable name="alreadyIDd" type="boolean" value="contactPicture.contains(contact)">
            <Comment>Whether or not the contact has been added to this entity's contact picture</Comment>
        </LocalVariable>
        <Schedule condition="sensor == collisionDetection &amp;&amp; (alreadyIDd || isFriendlyForce)" delay="0.0" event="AssessObstacle" priority="0">
            <Comment>If the sensor that detected the mover is the collision detection sensor, process the mover as an obstacle</Comment>
            <EdgeParameter value="contact"/>
        </Schedule>
        <Schedule condition="sensor == airSearchRadar &amp;&amp; !isFriendlyForce &amp;&amp; !alreadyIDd &amp;&amp; contact.getCruiseSpeed() &gt; 0" delay="0.0" event="PrepareContactMessage" priority="0">
            <Comment/>
            <EdgeParameter value="contact"/>
        </Schedule>
        <Code>/*System.out.println(getName() + " Detected: " + contact.getName());*/</Code>
        <Coordinate x="300" y="10"/>
    </Event>
    <Event name="AssessObstacle">
        <Comment>This event uses diskit.util.MovementCalculator to determine if this entity is going to collide with the obstacle</Comment>
        <Argument name="obstacle" type="diskit.Mover3D">
            <Comment>The mover being evaluated as a potential obstacle</Comment>
        </Argument>
        <LocalVariable name="obstacleToAvoid" type="boolean" value="willCollide(obstacle, collisionDetection, avoidanceRange)">
            <Comment>Method call to diskit.SMALMover3D that uses diskit.util.MovementCalculator to determine if there will be a collision</Comment>
        </LocalVariable>
        <Schedule condition="obstacleToAvoid " delay="0.0" event="AvoidObstacle" priority="0">
            <Comment>If I am going to hit this obstacle, and its bigger then I am (give way vessel simulated) or it's not moving then avoid it</Comment>
            <EdgeParameter value="obstacle"/>
        </Schedule>
        <Code/>
        <Coordinate x="300" y="150"/>
    </Event>
    <Event name="AvoidObstacle">
        <Comment>If a collision will occur avoid the obstacle using the avoidance mover manager. The avoidance mover manager will perform the avoidance and then reset the activeMoverManager to its pre-avoidance value after completing the avoidance maneuver.</Comment>
        <Argument name="obstacle" type="diskit.Mover3D">
            <Comment>The obstacle that must be avoided</Comment>
        </Argument>
        <LocalVariable name="avoidancePoint" type="diskit.Vec3d" value="getAvoidancePoint(obstacle)">
            <Comment>Method call to diskit.SMALMover3D to get the exact avoidance point for this obstacle</Comment>
        </LocalVariable>
        <StateTransition state="avoidanceMoverManager">
            <Operation method="setMover(this)"/>
        </StateTransition>
        <StateTransition state="avoidanceMoverManager">
            <Operation method="avoidToOffset(avoidancePoint, getActiveMoverManager())"/>
        </StateTransition>
        <Code/>
        <Coordinate x="300" y="260"/>
    </Event>
    <Event name="BuildSensorArray">
        <Comment>Combines all sensors in an array</Comment>
        <LocalVariable name="multipleSensors" type="diskit.Sensor[]" value="new diskit.Sensor[3]">
            <Comment>Initialized to the maximum number of sensors possible for this object</Comment>
        </LocalVariable>
        <Schedule condition="true" delay="0.0" event="RegisterSensors" priority="0">
            <Comment/>
            <EdgeParameter value="multipleSensors"/>
        </Schedule>
        <Code>multipleSensors[0] = digitalCamera;
multipleSensors[1] = airSearchRadar;
multipleSensors[2] = collisionDetection;</Code>
        <Coordinate x="100" y="150"/>
    </Event>
    <Event name="PrepareContactMessage">
        <Comment>Prepares the contact report, calculates the delay, and adds this contact to the contact picture</Comment>
        <Argument name="contact" type="diskit.Mover3D">
            <Comment>The contact of interest</Comment>
        </Argument>
        <LocalVariable name="contactLocation" type="java.lang.String" value="harborChart.findClosestZone(contact.getLocation()).getName()">
            <Comment/>
        </LocalVariable>
        <LocalVariable name="report" type="java.lang.String" value="&quot;|Contact Report| &quot; + getName() + &quot; detects unidentified contact IVO &quot; + contactLocation + &quot; --|| End Transmission&quot;">
            <Comment>Contact report template from this object</Comment>
        </LocalVariable>
        <StateTransition state="radioCommunication">
            <Operation method="setContext(contact)"/>
        </StateTransition>
        <StateTransition state="radioCommunication">
            <Operation method="setTimeStamp(Schedule.getSimTime())"/>
        </StateTransition>
        <StateTransition state="transmitDelay">
            <Assignment value="java.lang.Math.max(0.0,communicationDelay.generate())"/>
        </StateTransition>
        <StateTransition state="radioCommunication">
            <Operation method="setMessage(report)"/>
        </StateTransition>
        <StateTransition state="contactPicture">
            <Operation method="add(contact)"/>
        </StateTransition>
        <Schedule condition="true" delay="transmitDelay" event="SendRadioMessage" priority="0">
            <Comment/>
            <EdgeParameter value="radioCommunication"/>
        </Schedule>
        <Code/>
        <Coordinate x="400" y="10"/>
    </Event>
    <Event name="AStarZoneMapDistributed">
        <Comment>Receives a copy of a registered AStarZoneMap if one exists, only used to here sequence start up.</Comment>
        <Argument name="recipient" type="simkit.SimEntity">
            <Comment>intended recipient of this shared event</Comment>
        </Argument>
        <Argument name="zoneMap" type="diskit.AStarZoneMap">
            <Comment>The A* zone map for this simulation</Comment>
        </Argument>
        <Schedule condition="recipient == this" delay="0.0" event="SetNavigableZones" priority="0.0">
            <Comment/>
            <EdgeParameter value="zoneMap"/>
        </Schedule>
        <Code/>
        <Coordinate x="10" y="240"/>
    </Event>
    <Event name="SendRadioMessage">
        <Comment>Transmits the radio message through the scenario manager</Comment>
        <Argument name="msg" type="diskit.RadioCommunication">
            <Comment>The message to be transmitted</Comment>
        </Argument>
        <StateTransition state="reportedContacts">
            <Assignment value="reportedContacts + 1"/>
        </StateTransition>
        <Code/>
        <Coordinate x="400" y="90"/>
    </Event>
    <Event name="SetNavigableZones">
        <Comment/>
        <Argument name="zoneMap" type="diskit.AStarZoneMap">
            <Comment>navigable zones for this entity</Comment>
        </Argument>
        <StateTransition state="harborChart">
            <Assignment value="zoneMap"/>
        </StateTransition>
        <Schedule condition="harborChart != null" delay="0.0" event="ProcessZones" priority="0.0">
            <Comment/>
        </Schedule>
        <Code/>
        <Coordinate x="10" y="360"/>
    </Event>
</SimEntity>
